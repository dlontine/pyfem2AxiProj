<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.6. Assembly, Part I &mdash; pyfem2 3.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pyfem2 3.0 documentation" href="../index.html" />
    <link rel="up" title="5. Implementation Details" href="index.html" />
    <link rel="next" title="5.7. Application of Boundary Conditions" href="Boundary2.html" />
    <link rel="prev" title="5.5. Source terms and Distributed Loads" href="DistributedLoads.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="assembly-part-i">
<span id="assembly1"></span><h1>5.6. Assembly, Part I<a class="headerlink" href="#assembly-part-i" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>5.6.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Assembly is the process of merging element equations in to their
corresponding locations in the global equations. The assembler described
constructs and merges one element at a time and adopts the following
assumptions:</p>
<ul class="simple">
<li>nodes are ordered continuously from <span class="math">\(0\rightarrow n-1\)</span>, where
<span class="math">\(n\)</span> is the total number of nodes,</li>
<li>the number and type of degrees of freedom at each node is the same,</li>
<li>there are no multifreedom constraints, and</li>
<li>the global stiffness matrix is stored as a full symmetric matrix.</li>
</ul>
</div>
<div class="section" id="assembly-by-example">
<h2>5.6.2. Assembly by Example<a class="headerlink" href="#assembly-by-example" title="Permalink to this headline">¶</a></h2>
<p>Consider the truss in Figure [fig:ass.truss.1], each node has two
degrees of freedom (translation in the <span class="math">\(x\)</span> and <span class="math">\(y\)</span>
directions), giving <span class="math">\(3\)</span> nodes <span class="math">\(\times\)</span> 2 DOF/node = 6 DOF
for the structure. The array of global displacements <span class="math">\(\{u\}\)</span> is
organized as</p>
<div class="math">
\[\begin{split}\label{eq:ass.ug.1}
  \{u\} = \begin{Bmatrix}
    u_x^0 \\ u_y^0 \\ u_x^1 \\ u_y^1 \\ u_x^2 \\ u_y^2
  \end{Bmatrix} =
  \begin{Bmatrix}
    u_0 \\ u_1 \\ u_2 \\ u_3 \\ u_4 \\ u_5
  \end{Bmatrix}\end{split}\]</div>
<p>The associated global stiffness is a <span class="math">\(6\times6\)</span> matrix that we
initialize with zeros:</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../_images/Truss1.png"><img alt="../_images/Truss1.png" src="../_images/Truss1.png" style="width: 357.0px; height: 363.0px;" /></a>
<p class="caption"><span class="caption-text">Example two element truss.</span></p>
</div>
<div class="math">
\[\begin{split}\label{ass.K.1}
  \left[K\right] = \begin{bmatrix}
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0
  \end{bmatrix}\end{split}\]</div>
<p>Element 0 joins nodes 0 and 1. From , the local-to-global-DOF mapping
for nodes 0 and 1 is:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="37%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Node</th>
<th class="head">Local DOF</th>
<th class="head">Global DOF</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td><span class="math">\(x\)</span></td>
<td>0</td>
</tr>
<tr class="row-odd"><td>0</td>
<td><span class="math">\(y\)</span></td>
<td>1</td>
</tr>
<tr class="row-even"><td>1</td>
<td><span class="math">\(x\)</span></td>
<td>2</td>
</tr>
<tr class="row-odd"><td>1</td>
<td><span class="math">\(y\)</span></td>
<td>3</td>
</tr>
</tbody>
</table>
<p>The global degrees of freedom of an element are collected in the element
freedom table: . The element stiffness matrix <span class="math">\(\left[k^0\right]\)</span>
is a fully populated matrix given on the left below with the element
freedom table entries marking the columns and rows. The result of
merging the element stiffness <span class="math">\(\left[k^0\right]\)</span> in to the global
stiffness <span class="math">\(\left[K\right]\)</span> is shown on the right.</p>
<div class="math">
\[\begin{split}\label{ass.k1.1}
  \stackrel{\begin{matrix}
      \hphantom{k_{11}^0} &amp;
      \hphantom{k_{12}^0} &amp;
      \hphantom{k_{13}^0} &amp;
      \hphantom{k_{14}^0} \\ 0 &amp; 1 &amp; 2 &amp; 3 \end{matrix}}{
  \begin{bmatrix}
    k_{11}^0 &amp; k_{12}^0 &amp; k_{13}^0 &amp; k_{14}^0 \\
    k_{21}^0 &amp; k_{22}^0 &amp; k_{23}^0 &amp; k_{24}^0 \\
    k_{31}^0 &amp; k_{32}^0 &amp; k_{33}^0 &amp; k_{34}^0 \\
    k_{41}^0 &amp; k_{42}^0 &amp; k_{43}^0 &amp; k_{44}^0
  \end{bmatrix}}\begin{matrix}0\\1\\2\\3\end{matrix} \longrightarrow
  \stackrel{\begin{matrix}
      \hphantom{k_{11}^0} &amp;
      \hphantom{k_{12}^0} &amp;
      \hphantom{k_{13}^0} &amp;
      \hphantom{k_{14}^0} &amp;
      \hphantom{0} &amp;
      \hphantom{0} \\ 0 &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 \end{matrix}}{
  \begin{bmatrix}
    k_{11}^0 &amp; k_{12}^0 &amp; k_{13}^0 &amp; k_{14}^0 &amp; 0 &amp; 0 \\
    k_{21}^0 &amp; k_{22}^0 &amp; k_{23}^0 &amp; k_{24}^0 &amp; 0 &amp; 0\\
    k_{31}^0 &amp; k_{32}^0 &amp; k_{33}^0 &amp; k_{34}^0 &amp; 0 &amp; 0\\
    k_{41}^0 &amp; k_{42}^0 &amp; k_{43}^0 &amp; k_{44}^0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
    0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0
  \end{bmatrix}}\begin{matrix}0\\1\\2\\3\\4\\5\\ \end{matrix}\end{split}\]</div>
<p>The local-to-global-DOF mapping can be generalized as:</p>
<div class="math">
\[\label{eq:ass.mapping}
  \text{GLOBAL DOF} = \text{NUMBER OF DOF PER NODE}\times\text{NODE
    NUMBER} + \text{LOCAL DOF}\]</div>
<p><span class="math">\(\text{LOCAL DOF}\)</span> is one of the following integers:</p>
<table border="1" class="docutils">
<colgroup>
<col width="61%" />
<col width="39%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">DOF description</th>
<th class="head">LOCAL DOF</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><span class="math">\(x\)</span></td>
<td>0</td>
</tr>
<tr class="row-odd"><td><span class="math">\(y\)</span></td>
<td>1</td>
</tr>
<tr class="row-even"><td><span class="math">\(z\)</span></td>
<td>2</td>
</tr>
<tr class="row-odd"><td><span class="math">\(\theta_x\)</span></td>
<td>3</td>
</tr>
<tr class="row-even"><td><span class="math">\(\theta_y\)</span></td>
<td>4</td>
</tr>
<tr class="row-odd"><td><span class="math">\(\theta_z\)</span></td>
<td>5</td>
</tr>
<tr class="row-even"><td><span class="math">\(T\)</span></td>
<td>6</td>
</tr>
</tbody>
</table>
<p>Applying to Element 1, the element freedom table is and
<span class="math">\(\left[k^1\right]\)</span> and <span class="math">\(\left[K\right]\)</span> are:</p>
<div class="math">
\[\begin{split}\label{eq:ass.k1.2}
  \stackrel{\begin{matrix}
      \hphantom{k_{11}^0} &amp;
      \hphantom{k_{12}^0} &amp;
      \hphantom{k_{13}^0} &amp;
      \hphantom{k_{14}^0} \\ 0 &amp; 1 &amp; 4 &amp; 5 \end{matrix}}{
  \begin{bmatrix}
    k_{11}^1 &amp; k_{12}^1 &amp; k_{13}^1 &amp; k_{14}^1 \\
    k_{21}^1 &amp; k_{22}^1 &amp; k_{23}^1 &amp; k_{24}^1 \\
    k_{31}^1 &amp; k_{32}^1 &amp; k_{33}^1 &amp; k_{34}^1 \\
    k_{41}^1 &amp; k_{42}^1 &amp; k_{43}^1 &amp; k_{44}^1
  \end{bmatrix}}\begin{matrix}0\\1\\4\\5\end{matrix} \longrightarrow
  \stackrel{\begin{matrix}
      \hphantom{k_{11}^0+k_{11}^1} &amp;
      \hphantom{k_{12}^0+k_{11}^1} &amp;
      \hphantom{k_{13}^0} &amp;
      \hphantom{k_{14}^0} &amp;
      \hphantom{k_{11}^1} &amp;
      \hphantom{k_{11}^1} \\ 0 &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 \end{matrix}}{
  \begin{bmatrix}
    k_{11}^0+k_{11}^1 &amp; k_{12}^0+k_{11}^1 &amp; k_{13}^0 &amp; k_{14}^0 &amp; k_{13}^1 &amp; k_{23}^1 \\
    k_{21}^0+k_{12}^1 &amp; k_{22}^0+k_{22}^1 &amp; k_{23}^0 &amp; k_{24}^0 &amp; k_{14}^1 &amp; k_{24}^1 \\
    k_{31}^0 &amp; k_{32}^0 &amp; k_{33}^0 &amp; k_{34}^0 &amp; 0 &amp; 0\\
    k_{41}^0 &amp; k_{42}^0 &amp; k_{43}^0 &amp; k_{44}^0 &amp; 0 &amp; 0\\
    k_{31}^1 &amp; k_{32}^1 &amp; 0 &amp; 0 &amp; k_{33}^1 &amp; k_{34}^1\\
    k_{41}^1 &amp; k_{42}^1 &amp; 0 &amp; 0 &amp; k_{43}^1 &amp; k_{44}^1\\
  \end{bmatrix}}\begin{matrix}0\\1\\2\\3\\4\\5\\ \end{matrix}\end{split}\]</div>
<p>[assembly] When assembling the global finite element stiffness, the
following questions must be answered in the affirmitive:</p>
<ul class="simple">
<li>Is the value of <span class="math">\(K_{II}\)</span> equal to the sum of all elements
connected to node <span class="math">\(I\)</span>?</li>
<li>Is the value of <span class="math">\(K_{IJ}\)</span>, <span class="math">\(I\ne J\)</span>, equal to the negative
of all elements connecting nodes <span class="math">\(I\)</span> and <span class="math">\(J\)</span>?</li>
<li>Is the stiffness symmetric?</li>
</ul>
<p>Looking at the global system in , it is clear that each of the three
preceding questions can be answered in the affirmitive.</p>
</div>
<div class="section" id="assembler-computational-implementation">
<h2>5.6.3. Assembler Computational Implementation<a class="headerlink" href="#assembler-computational-implementation" title="Permalink to this headline">¶</a></h2>
<p>Assemblers for the global stiffness and global force are presented.</p>
<div class="section" id="global-stiffness">
<h3>5.6.3.1. Global Stiffness<a class="headerlink" href="#global-stiffness" title="Permalink to this headline">¶</a></h3>
<p>Assembly of the global stiffness is performed in , shown in Listing
[lst:ass.ass.1]. stands for “Uniform Degree of Freedom”. is defined in
and is invoked as</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">K</span> <span class="o">=</span> <span class="n">AssembleGlobalStiffnessUDOF</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">elemap</span><span class="p">,</span><span class="n">eletyp</span><span class="p">,</span><span class="n">elecon</span><span class="p">,</span><span class="n">elemat</span><span class="p">,</span><span class="n">elefab</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments to are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">coord</span></code></td>
<td>Nodal coordinates. is the ith coordinate of node n.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">elemap</span></code></td>
<td>Element label map. is the internal node number of the external node label xelem.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">elecon</span></code></td>
<td>Element connectivity. is the nth internal node label of element e.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">eletyp</span></code></td>
<td>Element types. is the element type of element .</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">elemat</span></code></td>
<td>Element material properties. is the nth material property of element e.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">elefab</span></code></td>
<td>Element fabrication properties. is the nth element fabrication property of element e.</td>
</tr>
</tbody>
</table>
<p>The output from is:</p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="95%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">K</span></code></td>
<td>Global stiffness matrix stored as a full (nd*n, nd*n) symmetric matrix, where nd is the number of degrees of freedom per node and n the total number of nodes.</td>
</tr>
</tbody>
</table>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">AssembleGlobalStiffnessUDOF</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">elemap</span><span class="p">,</span> <span class="n">eletyp</span><span class="p">,</span> <span class="n">elecon</span><span class="p">,</span> <span class="n">elemat</span><span class="p">,</span>
                                <span class="n">elefab</span><span class="p">,</span> <span class="n">dltags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dlvals</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">coord</span><span class="p">,</span> <span class="n">elecon</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span> <span class="n">asarray</span><span class="p">(</span><span class="n">elecon</span><span class="p">)</span>
    <span class="c1"># number of nodes and degrees of freedom per node</span>
    <span class="n">numnod</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndof</span> <span class="o">=</span> <span class="n">NumberOfDOFPerNode</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Default surface tags/values</span>
    <span class="n">numele</span> <span class="o">=</span> <span class="n">elecon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># compute the element stiffness and scatter to global array</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">ndof</span><span class="o">*</span><span class="n">numnod</span><span class="p">,</span> <span class="n">ndof</span><span class="o">*</span><span class="n">numnod</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elecon</span><span class="p">):</span>
        <span class="c1"># Element stiffness</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span><span class="n">NodesPerElement</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="n">e</span><span class="p">])]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">elemat</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">elefab</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dltags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dltags</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">dlvals</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
        <span class="n">Ke</span> <span class="o">=</span> <span class="n">ElementStiffness</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Ke</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xel</span> <span class="o">=</span> <span class="n">elemap</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">elemap</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iel</span><span class="p">)]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Element </span><span class="si">%d</span><span class="s1"> has unkown element type&#39;</span> <span class="o">%</span> <span class="n">xel</span><span class="p">)</span>
        <span class="c1"># GLOBAL DOF = NUMBER OF DOF PER NODExNODE NUMBER + LOCAL DOF</span>
        <span class="n">eft</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">([[</span><span class="n">ndof</span><span class="o">*</span><span class="n">ni</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndof</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">c</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ke</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">eft</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Ke</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">eft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">K</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Ke</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">K</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">K</span>
</pre></div>
</div>
<p>The subordinate function computes the element stiffness matrix. is shown
in Listing [lst:ass.elemstiff]. Details of each element stiffness are
presented in Appendix [app:elem.lib]. The heart of the assembly process
is constructing the element freedom table, represented by the symbol .
The element freedom table contains the global degree of freedom number
for the nodes in the element. For elements having uniform degrees of
freedom, this table can be constructed on the fly using . In , the
element freedom table is constructed by creating a nested list of global
DOF for each node on the element and flattening it. For example, for an
element having 2 degrees of freedom per node and having nodes and , the
element freedom table is formed by</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ElementStiffness</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">eletyp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">L1D2</span><span class="p">,</span> <span class="n">L2D2</span><span class="p">,</span> <span class="n">L3D2</span><span class="p">):</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">return</span> <span class="n">Link2Stiffness</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">eletyp</span> <span class="o">==</span> <span class="n">B1D2</span><span class="p">:</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Izz</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">return</span> <span class="n">Beam2Stiffness</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Izz</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">eletyp</span> <span class="o">==</span> <span class="n">B2D2</span><span class="p">:</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Izz</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">return</span> <span class="n">BeamColumn2Stiffness</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Izz</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">eletyp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">H2D3</span><span class="p">,):</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">dltags</span><span class="p">,</span> <span class="n">dlvals</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">Ke</span> <span class="o">=</span> <span class="n">HeatConductionStiffness</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="c1"># Convection contribution</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EdgesPerElement</span><span class="p">(</span><span class="n">eletyp</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dltags</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">QCONV</span><span class="p">:</span>
                <span class="n">Ke</span> <span class="o">+=</span> <span class="n">HeatConvectionStiffness</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dlvals</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Ke</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</div>
</div>
<div class="section" id="global-force">
<h3>5.6.3.2. Global Force<a class="headerlink" href="#global-force" title="Permalink to this headline">¶</a></h3>
<p>Assembly of the global force is performed in , shown in Listing
[lst:ass.ass.2]. is defined in and is invoked as</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">F</span> <span class="o">=</span> <span class="n">AssembleGlobalForceUDOF</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">elemap</span><span class="p">,</span> <span class="n">eletyp</span><span class="p">,</span> <span class="n">elecon</span><span class="p">,</span> <span class="n">doftags</span><span class="p">,</span> <span class="n">dofvals</span><span class="p">,</span>
                            <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">dltags</span><span class="o">=</span><span class="n">dltags</span><span class="p">,</span> <span class="n">dlvals</span><span class="o">=</span><span class="n">dlvals</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments to are</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">coord</span></code></td>
<td>Nodal coordinates. is the ith coordinate of node n.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">elemap</span></code></td>
<td>Element label map. is the internal node number of the external node label xelem.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">elecon</span></code></td>
<td>Element connectivity. is the nth internal node label of element e.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">eletyp</span></code></td>
<td>Element types. is the element type of element .</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">doftags</span></code></td>
<td>Degree of freedom tags. if the jth degree of freedom of node i has a known (prescribed) displacement, otherwise the node has a known force and .</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">dofvals</span></code></td>
<td>Degree of freedom values. is the magnitude of the cooresponding to the prescribed condition indicated by .</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">f</span></code></td>
<td>Node source. is the magnitude of the source contribution at a node.</td>
</tr>
</tbody>
</table>
<p>The output from is:</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">F</span></code></td>
<td>Global force array stored as a full nd*n array, where nd is the number of degrees of freedom per node and n the total number of nodes.</td>
</tr>
</tbody>
</table>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">AssembleGlobalForceUDOF</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">elemap</span><span class="p">,</span> <span class="n">eletyp</span><span class="p">,</span> <span class="n">elecon</span><span class="p">,</span> <span class="n">doftags</span><span class="p">,</span> <span class="n">dofvals</span><span class="p">,</span>
                            <span class="n">f</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dltags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dlvals</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">doftags</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">doftags</span> <span class="o">=</span> <span class="n">doftags</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dofvals</span> <span class="o">=</span> <span class="n">dofvals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">coord</span><span class="p">,</span> <span class="n">elecon</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">coord</span><span class="p">),</span> <span class="n">asarray</span><span class="p">(</span><span class="n">elecon</span><span class="p">)</span>
    <span class="c1"># number of nodes and degrees of freedom per node</span>
    <span class="n">numnod</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndof</span> <span class="o">=</span> <span class="n">NumberOfDOFPerNode</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Force contribution on Neummann boundary</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">dofvals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">doftags</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">NEUMANN</span> <span class="k">else</span> <span class="mf">0.</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numnod</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndof</span><span class="p">)])</span>

    <span class="c1"># compute contribution from element sources and boundary fluxes</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">ndof</span><span class="o">*</span><span class="n">numnod</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elecon</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span><span class="n">NodesPerElement</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="n">e</span><span class="p">])]</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dltags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dltags</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">dlvals</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
        <span class="n">Fe</span> <span class="o">=</span> <span class="n">ElementForce</span><span class="p">(</span><span class="n">eletyp</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Fe</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xel</span> <span class="o">=</span> <span class="n">elemap</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">elemap</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iel</span><span class="p">)]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Element </span><span class="si">%d</span><span class="s1"> has unkown element type&#39;</span> <span class="o">%</span> <span class="n">xel</span><span class="p">)</span>

        <span class="c1"># GLOBAL DOF = NUMBER OF DOF PER NODExNODE NUMBER + LOCAL DOF</span>
        <span class="n">eft</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">([[</span><span class="n">ndof</span><span class="o">*</span><span class="n">ni</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndof</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">c</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Fe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">F</span><span class="p">[</span><span class="n">eft</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">Fe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">F</span><span class="p">,</span> <span class="n">Q</span>
</pre></div>
</div>
<p>The subordinate function computes the element force array due to sources
and distributed loads. is shown shown in Listing [lst:ass.elemforce].
Details of each element force are presented in Appendix [app:elem.lib].</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ElementForce</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">xc</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Source array</span>
    <span class="n">Fe</span> <span class="o">=</span> <span class="n">ElementSourceArray</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Fe</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">eletyp</span> <span class="o">==</span> <span class="n">H2D3</span><span class="p">:</span>
        <span class="n">dltags</span><span class="p">,</span> <span class="n">dlvals</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EdgesPerElement</span><span class="p">(</span><span class="n">eletyp</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dltags</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">QCOND</span><span class="p">:</span>
                <span class="c1"># evaluate the boundary flux contribution</span>
                <span class="n">Fe</span> <span class="o">+=</span> <span class="n">ConductionFluxArray</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dlvals</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">dltags</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">QCONV</span><span class="p">:</span>
                <span class="c1"># evaluate the convection contribution</span>
                <span class="n">Fe</span> <span class="o">+=</span> <span class="n">ConvectionFluxArray</span><span class="p">(</span><span class="n">eletyp</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">dlvals</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Fe</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="verification-of-program-units">
<h2>5.6.4. Verification of Program Units<a class="headerlink" href="#verification-of-program-units" title="Permalink to this headline">¶</a></h2>
<div class="section" id="assembly-verification">
<h3>5.6.4.1. Assembly Verification<a class="headerlink" href="#assembly-verification" title="Permalink to this headline">¶</a></h3>
<div class="code python highlight-python"><div class="highlight"><pre>coord = [[0,0,0], [10,0,0], [10,10,0]]
elemap = {1:0, 2:1, 3:2}
elecon = [[0,1], [1,2], [0,2]]
eletyp = [L3D2, L3D2, L3D2]
elemat = [100] * 3
elefab = [1, .5, 2*sqrt(2.)]
K = AssembleGlobalStiffnessUDOF(coord,elemap,eletyp,elecon,elemat,elefab)
assert(array([[ 20.,  10.,   0., -10.,   0.,   0., -10., -10.,   0.],
              [ 10.,  10.,   0.,   0.,   0.,   0., -10., -10.,   0.],
              [  0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.],
              [-10.,   0.,   0.,  10.,   0.,   0.,   0.,   0.,   0.],
              [  0.,   0.,   0.,   0.,   5.,   0.,   0.,  -5.,   0.],
              [  0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.],
              [-10., -10.,   0.,   0.,   0.,   0.,  10.,  10.,   0.],
              [-10., -10.,   0.,   0.,  -5.,   0.,  10.,  15.,   0.],
              [  0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.]], K)
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">v</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="k">assert</span><span class="p">([</span> <span class="mf">45.3577</span><span class="p">,</span><span class="mf">16.74031</span><span class="p">,</span><span class="mf">7.902</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pyfem2</a></h1>





<p>
<iframe src="https://ghbtns.com/github-btn.html?user=tjfulle&repo=pyfem2&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction/index.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">2. <code class="docutils literal"><span class="pre">pyfem2</span></code> Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ModelDefinition/index.html">3. Defining a Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ElementLibrary/index.html">4. Element Library</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. Implementation Details</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Overview.html">5.1. Finite element analysis stages</a></li>
<li class="toctree-l2"><a class="reference internal" href="First.html">5.2. A First Finite Element Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="InternalNodesAndElements.html">5.3. Nodes and elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="Boundary1.html">5.4. Boundary conditions and concentrated loads</a></li>
<li class="toctree-l2"><a class="reference internal" href="DistributedLoads.html">5.5. Source terms and Distributed Loads</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">5.6. Assembly, Part I</a></li>
<li class="toctree-l2"><a class="reference internal" href="Boundary2.html">5.7. Application of Boundary Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Truss1.html">5.8. TrussSolution: A Complete Truss Program</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/index.html">6. <code class="docutils literal"><span class="pre">pyfem2</span></code> Source</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">5. Implementation Details</a><ul>
      <li>Previous: <a href="DistributedLoads.html" title="previous chapter">5.5. Source terms and Distributed Loads</a></li>
      <li>Next: <a href="Boundary2.html" title="next chapter">5.7. Application of Boundary Conditions</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Tim Fuller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="../_sources/Implementation/Assembly1.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>